---
title: "R-DINA JAGS Uninformative 1000 Analysis"
params:
  dataSet: R_DINA_SimpleQ_UnInform.1000
  guuid: 9
  simulationDirectory: "/Users/Dave/Dropbox/Graduate/Dissertation/DCM-Simulation-Results/Research-Project/9"
output:
  html_document:
    toc: yes
---

```{r knitr_opts, echo=TRUE, include=FALSE}
knitr::opts_knit$set(root.dir = params$simulationDirectory)
knitr::opts_chunk$set(tidy = TRUE, cache = TRUE)
```

```{r, message=FALSE, warning=FALSE, results="hide", echo=FALSE}
# Load R packages
library('devtools')
install_github("drackham/dcms", ref="develop")
library('dcms')
source("/Users/Dave/dev/EffectiveThetaBIN/Helpers/extractCodaVariables.R")
library('coda')
library('ggplot2')
library('ggmcmc')
library('parallel')
library('runjags')

##############################################################################
#                      Load the simulation                                   #
##############################################################################
load(paste("Sim.RData", sep=''))

##############################################################################
#                         Load the data                                      #
##############################################################################
# http://stackoverflow.com/questions/30951204/load-dataset-from-r-package-using-data-assign-it-directly-to-a-variable
data <- (function(...)get(data(...,envir = new.env())))(list = params$dataSet) 

dSim <- data$d
fSim <- data$f
J <- data$J

alpha1Sim <- data$alphaIK[,1]
alpha2Sim <- data$alphaIK[,2]

##############################################################################
#                         Transformations                                    #
##############################################################################
# Convert to coda object
codaSamples = as.mcmc.list(combine.mcmc(sim)) # resulting codaSamples object has these indices: codaSamples[[ chainIdx ]][ stepIdx , paramIdx ]
codaList <- as.mcmc.list(sim)

# Setup ggmcmc object
S <- ggs(as.mcmc.list(sim))
```

# Summary
Simulation ID: `r params$guuid
```{r echo = FALSE}
params$guuid
```


Dataset
```{r comment = "", echo = FALSE}
params$dataSet
```


Model
```{r comment="", echo = FALSE}
cat(readLines("R-DINA-Non-Hierarchical.jags"), sep = "\n")
```

# Convergence Diagnostics
## dHat parameter summaries
```{r echo = FALSE}
dHatSummary <- add.summary(sim, vars = c("dHat"))
dHatSummary
```

## fHat parameter summaries
```{r echo = FALSE}
fHatSummary <- add.summary(sim, vars = c("fHat"))
fHatSummary
```

## Geweke diagnostics
```{r echo = FALSE}
geweke <- geweke.diag(codaSamples)
geweke
```

## Raftery diagnostics
```{r echo = FALSE}
raftery <- raftery.diag(codaSamples)[[1]]$resmatrix[1:60,] # I should be less than 5
raftery
```

## dHat effective sample sizes
```{r echo = FALSE}
dHatEffectiveSize = matrix(nrow=J, ncol=2) # To Do: Add row.names
for (j in 1:J){
	dHatEffectiveSize[j,1] <- paste("dHat[", j, "]", sep="")
	dHatEffectiveSize[j,2] <- effectiveSize(codaSamples[,paste("dHat[", j, "]", sep="")])
}
dHatEffectiveSize
```

## fHat effective sample sizes
```{r echo = FALSE}
fHatEffectiveSize = matrix(nrow=J, ncol=2) # To Do: Add row.names
for (j in 1:J){
	fHatEffectiveSize[j,1] <- paste("fHat[", j, "]", sep="")
	fHatEffectiveSize[j,2] <- effectiveSize(codaSamples[,paste("fHat[", j, "]", sep="")])
}
fHatEffectiveSize
```

## Convergence plots
Creating convergence dHat.html plots
```{r dHat_convergence, echo = FALSE}
ggmcmc(S, file="dHat.html", plot=c("traceplot", "density", "autocorrelation"), family="dHat", param_page=4)
```

<!-- Creating convergence fHat.html plots -->
```{r fHat_convergence, echo = FALSE}
# ggmcmc(S, file="fHat.html", plot=c("traceplot", "density", "autocorrelation"), family="fHat", param_page=4)
```

```{r extractPosteriors, echo = FALSE}
##############################################################
# 						  Extract posterior means											 #
##############################################################

dHat <- extractCodaVariables(x=codaSamples, params='dHat', exact=FALSE)
fHat <- extractCodaVariables(x=codaSamples, params='fHat', exact=FALSE)

alpha1 <- extractCodaVariables(x=codaSamples, params='alpha1', exact=FALSE)
alpha2 <- extractCodaVariables(x=codaSamples, params='alpha2', exact=FALSE)
```


# dHat discrepencies
```{r echo = FALSE}

# Make vector of wanted parameter names
wanted_pars <- c(paste0("dHat[", 1:J, "]"))

# Get estimated and generating values for wanted parameters
generating_values = c(dSim)
estimated_values <- dHat

# Assesmble a data frame to pass to ggplot()
sim_df <- data.frame(parameter = factor(wanted_pars, rev(wanted_pars)), row.names = NULL)
sim_df$middle <- estimated_values[, "mean"] - generating_values
sim_df$lower <- estimated_values[, "2.5%"] - generating_values
sim_df$upper <- estimated_values[, "97.5%"] - generating_values

# Plot the discrepancy
ggplot(sim_df) + aes(x = parameter, y = middle, ymin = lower, ymax = upper) +
  scale_x_discrete() + geom_abline(intercept = 0, slope = 0, color = "white") +
  geom_linerange() + geom_point(size = 2) + labs(y = "Discrepancy", x = NULL, title = "dHat Sim vs. Predicted Discrepency") +
  theme(panel.grid = element_blank()) + coord_flip()
```

# fHat discrepencies
```{r echo = FALSE}
# Make vector of wanted parameter names
wanted_pars <- c(paste0("fHat[", 1:J, "]"))

# Get estimated and generating values for wanted parameters
generating_values = c(fSim)
estimated_values <- fHat

# Assesmble a data frame to pass to ggplot()
sim_df <- data.frame(parameter = factor(wanted_pars, rev(wanted_pars)), row.names = NULL)
sim_df$middle <- estimated_values[, "mean"] - generating_values
sim_df$lower <- estimated_values[, "2.5%"] - generating_values
sim_df$upper <- estimated_values[, "97.5%"] - generating_values

# Plot the discrepancy
ggplot(sim_df) + aes(x = parameter, y = middle, ymin = lower, ymax = upper) +
  scale_x_discrete() + geom_abline(intercept = 0, slope = 0, color = "white") +
  geom_linerange() + geom_point(size = 2) + labs(y = "Discrepancy", x = NULL, title = "fHat Sim vs. Predicted Discrepency") +
  theme(panel.grid = element_blank()) + coord_flip()
```

# Alpha recovery
``` {r echo = FALSE}
# Check alpha recovery
plot(alpha1Sim, alpha1[,1], main = "Alpha1 Recovery")
abline(a=0,b=1)

plot(alpha2Sim, alpha2[,1], main = "Alpha2 Recovery")
abline(a=0,b=1)
```

# Response recovery
Diff
``` {r echo = FALSE}
# Check Prob(response) recovery
probHat <- boot::inv.logit(fHat + dHat)
prob <- boot::inv.logit(fSim + dSim)

diff <- (prob - probHat)
mean(diff[,1])
```

# Guess and slip recovery
```{r echo = FALSE}
gSim <- boot::inv.logit(fSim)
sSim <- boot::inv.logit(fSim + dSim)

gHat <- boot::inv.logit(fHat[,1])
sHat <- boot::inv.logit(fHat[,1] + dHat[,1])

plot(gHat, gSim, main = "Guess simulated vs. predicted" )
abline(a = 0, b = 1)

plot(sHat, sSim, main = "Slip simulated vs. predicted" )
abline(a = 0, b = 1)
```